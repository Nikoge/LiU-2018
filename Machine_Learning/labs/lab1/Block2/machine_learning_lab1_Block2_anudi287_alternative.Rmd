for(it in 1:max_it) {
  Sys.sleep(0.5)
  
  # --------------------------------
  # E-step: Computation of the fractional component assignments
  p <- z
  for (i in 1:nrow(x)) {
    # Bernoulli pmf
    bernoulli <- matrix(ncol = D, nrow = K)
    for (j in 1:K) {
      bernoulli[j, ] <- (mu[j,]^x[i, ])*((1-mu[j,])^(1-x[i, ]))
    }
    bernoulli <- apply(bernoulli, 1, prod)
    p[i, ] <- bernoulli
  }
  
  for (i in 1:K) {
    p[, i] <- pi[i]*p[, i]
  }
  
  z <- p/apply(p, 1, sum)
  
  # Log likelihood computation.
  logllik <- sum(log(rowSums(p)))
  llik[it] <- logllik
  cat("iteration: ", it, "log likelihood: ", llik[it], "\n")
  flush.console()
  # --------------------------------
  # Stop if the log likelihood has not changed significantly
  if (it != 1) {
    if ((logllik - llik[it-1]) < min_change) {
      cols <- rainbow(K)
      plot(mu[1,], type="o", col=cols[1], ylim=c(0,1))
      for (i in 2:(K)) {
        points(mu[i,], type="o", col=cols[i])
      }
      llik <- data.frame(llik)
      llik$K <- K
      llik$iteration <- 1:nrow(llik)
      llik <- llik[which(llik$llik != 0), ]
      return (llik)
    }
  }
  
  # M-step: ML parameter estimation from the data and fractional component assignments
  pi <- colSums(z)/N
  mu <- t(z)%*%x/colSums(z)
  # return (list(pi, mu))
}
}