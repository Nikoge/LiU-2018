---
title: "Assignment_1_Visualization"
author: "Anubhav Dikshit and Yusur Almutair"
date: "10 September 2018"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Lab 1 Assignment 2

```{r}
library(readr)
library(data.table)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(plotly)
library(shiny)
```

### 1 Reading input
```{r}

data_senic <- read_table2("SENIC.txt", col_names = FALSE)

setnames(data_senic, old = c("X1", "X2", "X3", "X4", "X5", "X6", "X7", "X8", "X9", "X10", "X11", "X12"), 
                     new = c("ID", "length_of_stay", "avg_age", "avg_risk", "culturing_ratio", "chest_xray_ratio",
                           "avg_beds", "school_affil", "region", "avg_daily_census", "avg_nurses", "facility_per"))

# Fixing the datatypes

data_senic$school_affil <- factor(data_senic$school_affil, levels = c(1, 2),labels = c("Yes", "No"))
data_senic$region <- factor(data_senic$region, levels = c(1, 2, 3, 4),labels = c("NE", "NC", "S", "W"))
```

### 2. Function to calculate the oultiers
```{r}
quant_cal <- function(x){
  #x <-  mtcars$hp
  q1 <- as.numeric(quantile(x, probs = c(0.25)))
  q3 <- as.numeric(quantile(x, probs = c(0.75)))
  iqr <- q3-q1
  upper_value <- q3+(1.5*iqr)
  lower_value <- q1-(1.5*iqr)
  outliers_index <- which(x < lower_value | x > upper_value)
  #which(x %in% boxplot(x)$out) # must be equal to above
  return(outliers_index)
}
```

### 3. Plotting infection risk vs. outlier
```{r}
ggplot(data=data_senic, aes(x=avg_risk)) + geom_density() + geom_point(data = data_senic[quant_cal(data_senic$avg_risk), c("avg_risk")], aes(y = 0, x = avg_risk), shape=18, size=2) 
```

Analysis: We see that the number of outliers are fairly small, however this visualization is not very insightful

### 4. Plotting for all numeric columns
```{r}
data_senic_numeric <- data_senic[,c("ID", "length_of_stay", "avg_age", "avg_risk", "culturing_ratio", "chest_xray_ratio", "avg_beds", "avg_daily_census", "avg_nurses", "facility_per")]

ploting_helper <-  function(variable, bw){
  variable = "length_of_stay"
  bw = 0.5
  data_filtered = as.data.frame(data_senic_numeric[[variable]])
  colnames(data_filtered) <- eval(variable)
 x <- ggplot(data=data_senic_numeric, aes(x=variable)) + geom_density(bw=bw) + geom_point(data = as.data.frame(quant_cal(data_filtered[,1])), aes(y = 0, x = variable), shape=18, size=2)
  return(x)}

p1 <- ploting_helper(length_of_stay, 0.5)  
p2 <- ploting_helper(avg_age, 0.5)  
p3 <- ploting_helper(avg_risk, 0.5)  
p4 <- ploting_helper(culturing_ratio, 0.5)  
p5 <- ploting_helper(chest_xray_ratio, 0.5)  
p6 <- ploting_helper(avg_beds, 0.5)  
p7 <- ploting_helper(avg_daily_census, 0.5)  
p8 <- ploting_helper(avg_nurses, 0.5)  
 

p9 <- ggplot(data=data_senic_numeric, aes(x=facility_per)) + geom_density() # contains no outliers

# final output
grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, p9) # facility_per does not contain any outlier

```

Analysis: Most parameters are skewed towards right, while only age and risk are close to normally distributed


### 5. Plot of infection risk vs. number of beds
```{r}
ggplot(data = data_senic, aes(x = avg_nurses, y = avg_risk)) + geom_point(aes(color = avg_beds))
```

Analysis: We see trend between number of nurses and risk, as the number of nurses increases risk decrease but this only happens when the average nurse >200, this may be due to the fact that medical facilities with higher risks are higher in number than low risk hospital.
The risk of this colour profile is its hard to distinguish between the levels of beds.


### 6. Converting from ggplot2 to plotly
```{r}
ggplotly(p9)
```

Analysis: The ability to pan and zoom are now present.


### 7. Pipelining the plotly function

```{r}
data = data_senic_numeric[quant_cal(data_senic_numeric$avg_risk), c("avg_risk")]

data_senic %>% select(avg_risk) %>% plot_ly(x = ~avg_risk, type = "histogram") %>% 
  add_markers(x = data$avg_risk, y = 0, showlegend = FALSE, marker = list(color = "red", symbol = c('diamond')))

```

### 8. Shiny app
```{r}

library(shiny)

ui <- fluidPage(

    # Application title
    titlePanel("Select the variable to plot"),
    sidebarPanel(
            column(3,checkboxGroupInput(label = "variable", "Select Column to Plot",
                                        choices = c("length_of_stay", "avg_age", "avg_risk", "culturing_ratio",                                                          "chest_xray_ratio", "avg_beds", "avg_daily_census", "avg_nurses", "facility_per"),
                                        selected = "length_of_stay"))),
    
    sidebarPanel(
      column(4, sliderInput("bw_adjust", label = "Bandwidth adjustment:", min = 0.2, max = 2, value = 1, step = 0.2)), width = 10),
            
             
             mainPanel(plotOutput("plot")))


server <- shinyServer(function(input, output) {

    output$plot <- renderPlot({
      input$newplots
      grid.arrange(p1)

    })
  }
)

shinyApp(ui, server)
```